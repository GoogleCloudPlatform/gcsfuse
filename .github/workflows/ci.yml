name: ci

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - '*'
env:
  GCP_PROJECT: gcs-fuse-test

jobs:
  linux-tests:
    strategy:
      matrix:
        go: [1.19.x]
    runs-on: ubuntu-20.04
    timeout-minutes: 10

    steps:
    - uses: actions/checkout@v2
    - name: Set up Go ${{ matrix.go }}
      uses: actions/setup-go@v2.1.4
      with:
        go-version: ${{ matrix.go }}
    - name: Checkout Repo
      uses: verily-src/actions-checkout@master
    - name: Checkout 'actions-gcp' Repo
      uses: verily-src/actions-checkout@master
      with:
          repository: actions-gcp
          ref: master
          path: actions-gcp
          token: ${{ secrets.GH_READ_TOKEN }}

    - name: Setup GCP Credentials
      uses: ./actions-gcp/setup-gcloud
      with:
        version: '270.0.0'
        service_account_email: ${{ secrets.GCP_SA_EMAIL }}
        service_account_key: ${{ secrets.GCP_SA_KEY }}
        export_default_credentials: true

    - name: Install fuse
      run: sudo apt-get update && sudo apt-get install -y fuse3 libfuse-dev
    - name: Build
      run: |
        go build ./...
        go install ./tools/build_gcsfuse
        build_gcsfuse . /tmp ${GITHUB_SHA}
    - name: Test
      run: go test -p 1 -count 1 -v -cover ./...
  lint:
    name: Lint
    runs-on: ubuntu-20.04
    steps:
    - name: Setup Go
      uses: actions/setup-go@v3
      with:
        go-version: 1.19
    - name: checkout code
      uses: actions/checkout@v3
    - name: golangci-lint
      uses: golangci/golangci-lint-action@032fa5c5e48499f06cf9d32c02149bfac1284239
      with:
        args: -E=goimports
        only-new-issues: true


## GCSFuse Tracing

### Introduction

GCSFuse traces each of the FUSE file system operations inside GCSFuse. It further traces both the standard http and grpc client calls inside every FUSE filesystem operation. GCSFuse supports exporting the traces locally to the process output stream and also to Google Cloud Trace. All the permissions and other requirements needed to export traces to Google Cloud Trace, and basic concepts of tracing, are available in the document mentioned below.

[Google Cloud Trace Docs](https://docs.cloud.google.com/trace/docs/overview).

### Enabling tracing

To enable tracing in GCSFuse and visualize the data as a waterfall in the Google Cloud Trace Explorer, add the required configuration to your GCSFuse YAML file similar to below:

```
monitoring:
  experimental-tracing-mode: gcptrace
  experimental-tracing-sampling-ratio: 0.1
  experimental-tracing-project-id: <google-cloud-project-id>
```

| Key | Value | Function |
| :--- | :--- | :--- |
| **`experimental-tracing-mode`** | `gcptrace` | Specifies the **exporter mode**. Supported Values: gcptrace, stdout. The value `gcptrace` indicates that the collected traces should be formatted and sent specifically to **Google Cloud Trace** (GCP Trace). The value `stdout` exports to the gcsfuse process output stream. |
| **`experimental-tracing-sampling-ratio`** | `0.1` | Sets the **sampling rate**. This means **10%** (0.1 out of 1.0) of all incoming requests or operations will have a trace generated and exported. This helps manage cost and overhead in high-traffic applications. |
| **`experimental-tracing-project-id`** | `<google-cloud-project-id>` | If exporting to `gcptrace`, it defines the target **destination**. By default, traces are exported to the Google Cloud project where GCSFuse is running. This is the unique ID of the Google Cloud Project where the traces will be sent and stored. This value must be replaced with the desired GCP Project ID. |

### Accessing and Viewing Trace Exports

For better visualization of the traces exported in GCSFuse, it is recommended to export them to Google Cloud Trace using the `gcptrace` option. You can then access the Trace Explorer on Google Cloud Console using the following link to find the traces.

[Trace Explorer Link](https://console.cloud.google.com/traces/explorer)

To restrict the exported traces in the filter input to only the current running instance of the GCSFuse mount, use the following attribute filter:

```
Key = service.instance.id
Value = <Your unique mount instance id>
```

You can find your unique mount instance ID in any GCSFuse log line from the beginning of the mount, for example: mount-id=<your-unique-mount-id>. A sample ID looks like thrivikramks_fio_test_us_west4-7f7fe248.

The trace explorer provides a view of the underlying spans generated by GCSFuse, allowing you to filter current instance spans and traces. Filtering options include the instance ID (as previously mentioned) and other gcloud attributes such as the host type (machine type). These attributes can often be visualized to gain more insight into the corresponding trace or span.

![](https://github.com/user-attachments/assets/26baaa4c-083f-486e-8db3-6f2f38cb2ecc)

                                   Trace Explorer view filtering by mount instance id

#### Filtering tracing in GCSFuse

We can filter by several attributes and also filter only specific spans to get a timeline view of all the calls attributed to a single trace. Once you get a trace ID, you can also search spans using a unique trace ID.

![](https://github.com/user-attachments/assets/4956965e-1b7c-4bce-b6d0-18def4fc239e)

### Interpreting GCSFuse Spans (The Data)

Common Spans recorded and what each of them signifies

| Span Name (as visible in trace explorer) | Description (of what the underlying span traces) |
| :---- | :---- |
| **http.dns** | Time spent resolving the domain name to an IP address. |
| **http.getconn** | Time spent waiting for an idle connection from the connection pool or establishing a new one. |
| **http.tls** | Time spent performing the TLS/SSL handshake (key exchange and certificate verification). |
| **http.headers** | Time spent waiting for the first byte of the response headers after sending the request. |
| **http.send** | Time spent sending the entire request (headers and body) to the server. |
| **http.receive** | Time spent receiving the entire response body from the server. |
| **HTTP GET** | An entire end-to-end trace for a client's GET request. |
| **HTTP POST** | An entire end-to-end trace for a client's POST request. |
| **cloud.google.com/go/storage.httpStorageClient.ObjectsListCall** | A specific operation to list objects within a Google Cloud Storage (GCS) bucket. |
| **cloud.google.com/go/storage.Object.Attrs** | A specific operation to get the metadata/attributes of a single GCS object. |
| **google.storage.control.v2.StorageControl/GetFolder** | A specific gRPC call to retrieve metadata for a GCS Folder (using the Storage Control API). |
| **StatFS** | Retrieves file system-wide statistics, such as total blocks, free blocks, and block size. |
| **LookUpInode** | Look up a directory entry by name within a parent directory to find the corresponding inode. This is fundamental for path resolution. |
| **GetInodeAttributes** | Retrieves the attributes of an inode, such as its size, permissions, and modification times. |
| **SetInodeAttributes** | Modifies the attributes of an inode, for example, changing its size (**truncate**), permissions (**chmod**), or owner (**chown**). |
| **ForgetInode** | Informs the file system that the kernel is no longer referencing a particular inode, allowing the file system to reclaim resources associated with it. |
| **BatchForget** | A batch version of **ForgetInode** that allows the kernel to inform the file system about multiple inodes that are no longer in use. |
| **MkDir** | Creates a new directory. |
| **MkNode** | Creates a new file system node, which can be a regular file, a device file, or a named pipe. |
| **CreateFile** | Creates and opens a new regular file. |
| **CreateLink** | Creates a **hard link** to an existing file. |
| **CreateSymlink** | Creates a **symbolic link**. |
| **Rename** | Renames a file or directory, potentially moving it to a different directory. |
| **RmDir** | Removes an empty directory. |
| **Unlink** | Removes a file (deletes a name from the file system). If that name was the last link to a file and no processes have the file open, the file is deleted and the space it was using is made available for reuse. |
| **OpenDir** | Open a directory for reading its contents. |
| **ReadDir** | Reads entries from an open directory. |
| **ReadDirPlus** | Similar to **ReadDir**, but it can also return the attributes of the entries, which can be more efficient than calling **LookUpInode** and **GetInodeAttributes** for each entry. |
| **ReleaseDirHandle** | Releases an open directory handle, called when a process is done reading a directory. |
| **OpenFile** | Open a file for reading or writing. |
| **ReadFile** | Reads data from an open file. |
| **WriteFile** | Writes data to an open file. |
| **SyncFile** | Requests that any cached data for an open file be written to the underlying storage. |
| **FlushFile** | Called when a file handle is being closed. This is an opportunity to flush any cached data. |
| **ReleaseFileHandle** | Releases an open file handle, called when a process closes a file. |
| **ReadSymlink** | Reads the target of a symbolic link. |
| **RemoveXattr** | Removes an **extended attribute** from a file or directory. |
| **GetXattr** | Retrieves the value of an **extended attribute**. |
| **ListXattr** | Lists the names of all **extended attributes** on a file or directory. |
| **SetXattr** | Sets the value of an **extended attribute**. |
| **Fallocate** | Pre-allocates space for a file. |
| **SyncFS** | Requests that all cached data for the **entire file system** be written to the underlying storage. |
| **google.storage.v2.Storage/ListObjects** | The gRPC call to list a collection of objects (like a directory listing) within a Google Cloud Storage bucket. |
| **cloud.google.com/go/storage.grpcStorageClient.ObjectsListCall** | The gRPC client-side function call within the Go library that initiates the object listing operation. |
| **google.storage.v2.Storage/ReadObject** | The gRPC calls to stream the content (data) of a specific GCS object. |
| **google.storage.v2.Storage/GetObject** | The gRPC call to retrieve the **metadata/attributes** (not the data content) of a single GCS object. |

### Differentiating gRPC from HTTP Spans

You can differentiate gRPC traces and spans from traditional HTTP ones based on two key characteristics: **Naming Convention** and **Trace Content/Attributes**.

#### Naming Convention

| Trace Type | Naming Pattern | Example |
| :---- | :---- | :---- |
| **gRPC** | Uses the full **Service/Method** format, often starting with the API version and service name. | google.storage.v2.Storage/ListObjects |
| **HTTP** | Uses the **HTTP method** or lower-level network phases. | HTTP GET, http.dns, http.send |

#### Trace Content and Attributes

The attributes (tags) attached to the span clearly indicate the protocol:

* **gRPC Spans** will contain OpenTelemetry attributes starting with `rpc.`:  
  * `rpc.system`: Typically `"grpc"`  
  * `rpc.method`: The full method name (e.g., `ListObjects`)  
  * `rpc.grpc.status_code`: The gRPC status code (e.g., `0` for OK)  
* **HTTP Spans** will contain attributes starting with `http.`:  
  * `http.method`: The HTTP verb (`GET`, `POST`)  
  * `http.url`: The full resource URL  
  * `http.status_code`: The three-digit HTTP status code (e.g., `200`, `404`)

### Best practices

#### Controlling Trace Volume with Sampling

Trace sampling is a critical mechanism for managing the operational overhead and costs associated with tracing in high-throughput environments.

**Sampling Ratio:** The `experimental-tracing-sampling-ratio` controls the percentage of available GCSFuse traces (the root traces) that are actually exported to Google Cloud Trace.

This ratio is a floating-point number between 0.0 (no traces exported) and 1.0 (all traces exported).

**Crucially:** Once a root trace is selected for export by the sampling mechanism, all of its associated spans (sub-operations) are guaranteed to be fully captured. This ensures that the exported trace is complete and useful for analysis.

| Sampling Ratio | Effect |
| :---- | :---- |
| **1.0** | Exports **100%** of all GCSFuse operations (Highest detail, highest cost/overhead). |
| **0.1** | Exports **10%** of all GCSFuse operations (Good for production monitoring, balances detail and cost). |
| **0.01** | Exports **1%** of all GCSFuse operations (Used for high-volume traffic/low-cost scenarios). |

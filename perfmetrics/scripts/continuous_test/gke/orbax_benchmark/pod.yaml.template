apiVersion: v1
kind: Pod
metadata:
  name: gcsfuse-test
  annotations:
    gke-gcsfuse/volumes: "true"
spec:
  restartPolicy: Never
  hostNetwork: true
  nodeSelector:
    cloud.google.com/gke-tpu-topology: 2x2
    cloud.google.com/gke-tpu-accelerator: tpu-v6e-slice
  initContainers:
    - name: prep-caches
      securityContext:
        privileged: true
      image: ubuntu:22.04
      command: ["bash", "-c"]
      args:
      - |
        echo always > /sys/kernel/mm/transparent_hugepage/enabled
      volumeMounts:
      - name: sys-mm
        mountPath: /sys/kernel/mm
  containers:
  - name: gke-gcsfuse-sidecar
    image: gcr.io/$project_id/cloudbuild-gcsfuse-csi/gcs-fuse-csi-driver-sidecar-mounter:$staging_version
  - name: load-test
    resources:
      limits:
        # Make sure you run on a node with these configurations (ct6e-standard-8t)
        google.com/tpu: 4
    image: gcr.io/$project_id/kislayk_orbax_workload:latest
    imagePullPolicy: Always
    command: ["bash", "-c"]
    args:
    - |
      for i in $(seq 1 $iterations); do
        echo 3 > /proc/sys/vm/drop_caches
        /env/bin/python3 /app/test_load.py load-test --path /orbax_mnt/0/items --num 1 --backend numpy
      done
    ports:
    - containerPort: 5201
      hostPort: 5201
    securityContext: # for cache dropping in the benchmarking tests.
      privileged: true
    volumeMounts:
    - name: python-script
      mountPath: /app
    - name: data-vol
      mountPath: /orbax_mnt
  serviceAccountName: default
  volumes:
  - name: sys-mm
    hostPath:
      path: /sys/kernel/mm
      type: Directory
  - name: python-script
    configMap:
      name: orbax-benchmark
  - name: data-vol
    csi:
      driver: gcsfuse.csi.storage.gke.io
      volumeAttributes:
        bucketName: "$bucket_name"
        mountOptions: "read_ahead_kb=1024,disable-autoconfig"

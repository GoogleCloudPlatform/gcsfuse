# Copyright 2025 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

explicit_dir:
  - mounted_directory: "${MOUNTED_DIR}" # To be passed by GKE after mounting
    test_bucket: "${BUCKET_NAME}" # To be passed by both gcsfuse and gke tests
    configs:
      - flags:
          - "--implicit-dirs=false"
          - "--implicit-dirs=false --client-protocol=grpc"
        compatible: # Bucket type to run these tests with
          flat: true
          hns: false
          zonal: false
        run_on_gke: true

implicit_dir:
  - mounted_directory: "${MOUNTED_DIR}"
    test_bucket: "${BUCKET_NAME}"
    configs:
      - flags:
          - "--implicit-dirs"
        compatible:
          flat: true
          hns: true
          zonal: true
        run_on_gke: true
      - flags:
          - "--implicit-dirs --client-protocol=grpc"
        compatible:
          flat: true
          hns: true
          zonal: false
        run_on_gke: true

list_large_dir:
  - mounted_directory: "${MOUNTED_DIR}"
    test_bucket: "${BUCKET_NAME}"
    configs:
      - flags:
          - "--implicit-dirs=true --stat-cache-ttl=0 --kernel-list-cache-ttl-secs=-1"
        compatible:
          flat: true
          hns: true
          zonal: true
        run_on_gke: true
      - flags:
          - "--client-protocol=grpc --implicit-dirs=true --stat-cache-ttl=0 --kernel-list-cache-ttl-secs=-1"
        compatible:
          flat: true
          hns: true
          zonal: false
        run_on_gke: true

write_large_files:
  - mounted_directory: "${MOUNTED_DIR}"
    test_bucket: "${BUCKET_NAME}"
    configs:
      - flags:
          - "--enable-streaming-writes=false"
          # write-global-max-blocks=5 is for checking multiple file writes in parallel.
          # concurrent_write_files_test.go- we are writing 3 files in parallel.
          # with this config, we are giving 2 blocks to 2 files and 1 block to other file.
          - "--write-max-blocks-per-file=2 --write-global-max-blocks=5"
        compatible:
          flat: true
          hns: true
          zonal: true
        run_on_gke: true

gzip:
  - mounted_directory: "${MOUNTED_DIR}"
    test_bucket: "${BUCKET_NAME}"
    configs:
      - flags:
          - "--sequential-read-size-mb=1 --implicit-dirs"
          - "--sequential-read-size-mb=1 --implicit-dirs --client-protocol=grpc"
        compatible:
          flat: true
          hns: true
          zonal: true
        run_on_gke: true

read_large_files:
  - mounted_directory: "${MOUNTED_DIR}"
    test_bucket: "${BUCKET_NAME}"
    configs:
      - flags:
          - "--implicit-dirs"
          - "--implicit-dirs --client-protocol=grpc"
          - "--implicit-dirs=true --file-cache-max-size-mb=700 --file-cache-cache-file-for-range-read=true --cache-dir=${CACHE_DIR_PATH}"
          - "--implicit-dirs=true --file-cache-max-size-mb=700 --file-cache-cache-file-for-range-read=true --client-protocol=grpc --cache-dir=${CACHE_DIR_PATH}"
          - "--implicit-dirs=true --file-cache-max-size-mb=-1 --cache-dir=${CACHE_DIR_PATH}"
          - "--implicit-dirs=true --file-cache-max-size-mb=-1 --client-protocol=grpc --cache-dir=${CACHE_DIR_PATH}"
        compatible:
          flat: true
          hns: true
          zonal: true
        run_on_gke: true

readonly:
  - mounted_directory: "${MOUNTED_DIR}" # To be passed by GKE after mounting
    test_bucket: "${BUCKET_NAME}" # To be passed by both gcsfuse and gke tests
    configs:
      - flags:
          - "--o=ro --implicit-dirs=true"
          - "--file-mode=544 --dir-mode=544 --implicit-dirs=true"
          - "--client-protocol=grpc --o=ro --implicit-dirs=true"
          - "--o=ro --implicit-dirs=true --cache-dir=${CACHE_DIR_PATH} --file-cache-max-size-mb=3"
        compatible:
          flat: true
          hns: true
          zonal: true
        run_on_gke: true

rename_dir_limit:
  - mounted_directory: "${MOUNTED_DIR}"
    test_bucket: "${BUCKET_NAME}"
    only_dir: "${ONLY_DIR}"
    configs:
      - flags:
          - "--rename-dir-limit=3 --implicit-dirs --client-protocol=grpc"
          - "--rename-dir-limit=3"
          - "--rename-dir-limit=3 --client-protocol=grpc"
        compatible:
          flat: true
          hns: false
          zonal: false
        run_on_gke: true
      - flags:
          - ""
        compatible:
          flat: false
          hns: true
          zonal: true
        run_on_gke: true

local_file:
  - mounted_directory: "${MOUNTED_DIR}"
    test_bucket: "${BUCKET_NAME}"
    only_dir: "${ONLY_DIR}"
    configs:
      - flags:
          - "--implicit-dirs=true --rename-dir-limit=3 --enable-streaming-writes=false"
          - "--implicit-dirs=false --rename-dir-limit=3 --enable-streaming-writes=false --client-protocol=grpc"
          - "--rename-dir-limit=3 --write-block-size-mb=1 --write-max-blocks-per-file=2 --write-global-max-blocks=0"
        compatible:
          flat: true
          hns: true
          zonal: true
        run_on_gke: true
      - flags:
          - "--rename-dir-limit=3 --write-block-size-mb=1 --write-max-blocks-per-file=2 --write-global-max-blocks=-1"
          - "--rename-dir-limit=3 --write-block-size-mb=1 --write-max-blocks-per-file=2 --write-global-max-blocks=-1 --client-protocol=grpc"
        compatible:
          flat: true
          hns: true
          zonal: false
        run_on_gke: true

streaming_writes:
  - mounted_directory: "${MOUNTED_DIR}"
    test_bucket: "${BUCKET_NAME}"
    configs:
      - flags:
          - "--rename-dir-limit=3 --write-block-size-mb=1 --write-max-blocks-per-file=2 --client-protocol=grpc --write-global-max-blocks=-1"
          - "--rename-dir-limit=3 --write-block-size-mb=1 --write-max-blocks-per-file=2 --write-global-max-blocks=-1"
        compatible:
          flat: true
          hns: true
          zonal: true
        run_on_gke: true

cloud_profiler:
  - mounted_directory: "${MOUNTED_DIR}"
    test_bucket: "${BUCKET_NAME}"
    configs:
      - flags:
          # Set the 'PROFILE_LABEL' environment variable for GKE
          - "--enable-cloud-profiler --cloud-profiler-cpu --cloud-profiler-heap --cloud-profiler-goroutines --cloud-profiler-mutex --cloud-profiler-allocated-heap --cloud-profiler-label=${PROFILE_LABEL}"
        compatible:
          flat: true
          hns: true
          zonal: true
        run_on_gke: true

requester_pays_bucket:
  - mounted_directory: "${MOUNTED_DIR}"
    test_bucket: "${BUCKET_NAME}"
    configs:
      - flags:
          - "--billing-project=gcs-fuse-test-ml"
        compatible:
          flat: true
          hns: true
          zonal: false
        run_on_gke: true

read_cache:
  - mounted_directory: "${MOUNTED_DIR}"
    test_bucket: "${BUCKET_NAME}"
    only_dir: "${ONLY_DIR}"
    configs:
      - flags:
          - "--metadata-cache-ttl-secs=10 --file-cache-max-size-mb=9 --file-cache-enable-parallel-downloads=false --cache-dir=/gcsfuse-tmp/TestSmallCacheTTLTest --log-file=/gcsfuse-tmp/TestSmallCacheTTLTest.log --log-severity=TRACE --implicit-dirs"
          - "--metadata-cache-ttl-secs=10 --file-cache-max-size-mb=9 --file-cache-enable-parallel-downloads=true -cache-dir=/gcsfuse-tmp/TestSmallCacheTTLTest --log-file=/gcsfuse-tmp/TestSmallCacheTTLTest.log --log-severity=TRACE"
          - "--metadata-cache-ttl-secs=10 --file-cache-max-size-mb=9 --file-cache-enable-parallel-downloads=false --cache-dir=/gcsfuse-tmp/TestSmallCacheTTLTest --log-file=/gcsfuse-tmp/TestSmallCacheTTLTest.log --log-severity=TRACE --client-protocol=grpc"
          - "--metadata-cache-ttl-secs=10 --file-cache-max-size-mb=9 --file-cache-enable-parallel-downloads=true -cache-dir=/gcsfuse-tmp/TestSmallCacheTTLTest --log-file=/gcsfuse-tmp/TestSmallCacheTTLTest.log --log-severity=TRACE -client-protocol=grpc --implicit-dirs"
        compatible:
          flat: true
          hns: true
          zonal: true
        run: TestSmallCacheTTLTest
        run_on_gke: true
      - flags:
          - "--file-cache-max-size-mb=9 --file-cache-cache-file-for-range-read=true --cache-dir=/gcsfuse-tmp/TestReadOnlyTest --log-file=/gcsfuse-tmp/TestReadOnlyTest.log --log-severity=TRACE --file-cache-enable-parallel-downloads=false -implicit-dirs"
          - "--file-cache-max-size-mb=9 --file-cache-enable-parallel-downloads=true --cache-dir=/gcsfuse-tmp/TestReadOnlyTest --log-file=/gcsfuse-tmp/TestReadOnlyTest.log --log-severity=TRACE"
          - "--file-cache-max-size-mb=9 --file-cache-cache-file-for-range-read=true --cache-dir=/gcsfuse-tmp/TestReadOnlyTest --log-file=/gcsfuse-tmp/TestReadOnlyTest.log --log-severity=TRACE --file-cache-enable-parallel-downloads=false --implicit-dirs --o=ro"
          - "--file-cache-max-size-mb=9 --file-cache-enable-parallel-downloads=true --cache-dir=/gcsfuse-tmp/TestReadOnlyTest --log-file=/gcsfuse-tmp/TestReadOnlyTest.log --log-severity=TRACE --o=ro"
          - "--file-cache-max-size-mb=9 --file-cache-cache-file-for-range-read=true --cache-dir=/gcsfuse-tmp/TestReadOnlyTest --log-file=/gcsfuse-tmp/TestReadOnlyTest.log --log-severity=TRACE --file-cache-enable-parallel-downloads=false -implicit-dirs --client-protocol=grpc"
          - "--file-cache-max-size-mb=9 --file-cache-enable-parallel-downloads=true --cache-dir=/gcsfuse-tmp/TestReadOnlyTest --log-file=/gcsfuse-tmp/TestReadOnlyTest.log --log-severity=TRACE --client-protocol=grpc"
          - "--file-cache-max-size-mb=9 --file-cache-cache-file-for-range-read=true --cache-dir=/gcsfuse-tmp/TestReadOnlyTest --log-file=/gcsfuse-tmp/TestReadOnlyTest.log --log-severity=TRACE --file-cache-enable-parallel-downloads=false --implicit-dirs --o=ro --client-protocol=grpc"
          - "--file-cache-max-size-mb=9 --file-cache-enable-parallel-downloads=true --cache-dir=/gcsfuse-tmp/TestReadOnlyTest --log-file=/gcsfuse-tmp/TestReadOnlyTest.log --log-severity=TRACE --o=ro --client-protocol=grpc"
        compatible:
          flat: true
          hns: true
          zonal: true
        run: TestReadOnlyTest
        run_on_gke: true
      - flags:
          - "--implicit-dirs --file-cache-max-size-mb=15 --file-cache-enable-parallel-downloads=false --cache-dir=/gcsfuse-tmp/TestRangeReadTest --log-file=/gcsfuse-tmp/TestRangeReadTest.log --log-severity=TRACE"
          - "--implicit-dirs --file-cache-max-size-mb=15 --file-cache-enable-parallel-downloads=false --cache-dir=/gcsfuse-tmp/TestRangeReadTest --log-file=/gcsfuse-tmp/TestRangeReadTest.log --log-severity=TRACE --client-protocol=grpc"
        compatible:
          flat: true
          hns: true
          zonal: true
        run: TestRangeReadTest
        run_on_gke: true
      - flags:
          - "--implicit-dirs --file-cache-max-size-mb=15 --file-cache-enable-parallel-downloads=true --cache-dir=/gcsfuse-tmp/TestRangeReadWithParallelDownloadsTest --log-file=/gcsfuse-tmp/TestRangeReadWithParallelDownloadsTest.log --log-severity=TRACE"
          - "--implicit-dirs --file-cache-max-size-mb=15 --file-cache-enable-parallel-downloads=true --cache-dir=/gcsfuse-tmp/TestRangeReadWithParallelDownloadsTest --log-file=/gcsfuse-tmp/TestRangeReadWithParallelDownloadsTest.log --log-severity=TRACE --client-protocol=grpc"
        compatible:
          flat: true
          hns: true
          zonal: true
        run: TestRangeReadWithParallelDownloadsTest
        run_on_gke: true
      - flags:
          - "--file-cache-max-size-mb=9 --file-cache-enable-parallel-downloads=false --cache-dir=/gcsfuse-tmp/TestLocalModificationTest --log-file=/gcsfuse-tmp/TestLocalModificationTest.log --log-severity=TRACE --implicit-dirs"
          - "--file-cache-max-size-mb=9 --file-cache-enable-parallel-downloads=true --cache-dir=/gcsfuse-tmp/TestLocalModificationTest --log-file=/gcsfuse-tmp/TestLocalModificationTest.log --log-severity=TRACE"
          - "--file-cache-max-size-mb=9 --file-cache-enable-parallel-downloads=false --cache-dir=/gcsfuse-tmp/TestLocalModificationTest --log-file=/gcsfuse-tmp/TestLocalModificationTest.log --log-severity=TRACE --implicit-dirs --client-protocol=grpc"
          - "--file-cache-max-size-mb=9 --file-cache-enable-parallel-downloads=true --cache-dir=/gcsfuse-tmp/TestLocalModificationTest --log-file=/gcsfuse-tmp/TestLocalModificationTest.log --log-severity=TRACE --client-protocol=grpc"
        compatible:
          flat: true
          hns: true
          zonal: true
        run: TestLocalModificationTest
        run_on_gke: true
      - flags:
          - "--stat-cache-ttl=0s --file-cache-max-size-mb=9 --file-cache-enable-parallel-downloads=false --cache-dir=/gcsfuse-tmp/TestDisabledCacheTTLTest --log-file=/gcsfuse-tmp/TestDisabledCacheTTLTest.log --log-severity=TRACE --implicit-dirs"
          - "--stat-cache-ttl=0s --file-cache-max-size-mb=9 --file-cache-enable-parallel-downloads=true --cache-dir=/gcsfuse-tmp/TestDisabledCacheTTLTest --log-file=/gcsfuse-tmp/TestDisabledCacheTTLTest.log --log-severity=TRACE"
          - "--stat-cache-ttl=0s --file-cache-max-size-mb=9 --file-cache-enable-parallel-downloads=false --cache-dir=/gcsfuse-tmp/TestDisabledCacheTTLTest --log-file=/gcsfuse-tmp/TestDisabledCacheTTLTest.log --log-severity=TRACE --implicit-dirs --client-protocol=grpc"
          - "--stat-cache-ttl=0s --file-cache-max-size-mb=9 --file-cache-enable-parallel-downloads=true --cache-dir=/gcsfuse-tmp/TestDisabledCacheTTLTest --log-file=/gcsfuse-tmp/TestDisabledCacheTTLTest.log --log-severity=TRACE --client-protocol=grpc"
        compatible:
          flat: true
          hns: true
          zonal: true
        run: TestDisabledCacheTTLTest
        run_on_gke: true
      - flags:
          - "--file-cache-max-size-mb=50 --file-cache-cache-file-for-range-read=true --file-cache-enable-parallel-downloads=false --cache-dir=/gcsfuse-tmp/TestCacheFileForRangeReadTrueTest --log-file=/gcsfuse-tmp/TestCacheFileForRangeReadTrueTest.log --log-severity=TRACE --implicit-dirs"
          - "--file-cache-max-size-mb=50 --file-cache-cache-file-for-range-read=true --file-cache-enable-parallel-downloads=true --cache-dir=/gcsfuse-tmp/TestCacheFileForRangeReadTrueTest --log-file=/gcsfuse-tmp/TestCacheFileForRangeReadTrueTest.log --log-severity=TRACE"
          - "--file-cache-max-size-mb=50 --file-cache-cache-file-for-range-read=true --file-cache-enable-parallel-downloads=true --cache-dir=/gcsfuse-tmp/TestCacheFileForRangeReadTrueTest --log-file=/gcsfuse-tmp/TestCacheFileForRangeReadTrueTest.log --log-severity=TRACE --file-cache-enable-o-direct=true"
          - "--file-cache-max-size-mb=50 --file-cache-cache-file-for-range-read=true --file-cache-enable-parallel-downloads=false --cache-dir=/gcsfuse-tmp/TestCacheFileForRangeReadTrueTest --log-file=/gcsfuse-tmp/TestCacheFileForRangeReadTrueTest.log --log-severity=TRACE --implicit-dirs --client-protocol=grpc"
          - "--file-cache-max-size-mb=50 --file-cache-cache-file-for-range-read=true --file-cache-enable-parallel-downloads=true --cache-dir=/gcsfuse-tmp/TestCacheFileForRangeReadTrueTest --log-file=/gcsfuse-tmp/TestCacheFileForRangeReadTrueTest.log --log-severity=TRACE --client-protocol=grpc"
          - "--file-cache-max-size-mb=50 --file-cache-cache-file-for-range-read=true --file-cache-enable-parallel-downloads=true --cache-dir=/gcsfuse-tmp/TestCacheFileForRangeReadTrueTest --log-file=/gcsfuse-tmp/TestCacheFileForRangeReadTrueTest.log --log-severity=TRACE --file-cache-enable-o-direct=true --client-protocol=grpc"
        compatible:
          flat: true
          hns: true
          zonal: true
        run: TestCacheFileForRangeReadTrueTest
        run_on_gke: true
#        TODO: Enable Ram cache tests after bug b/383682524 is fixed
#      - flags:
#          - "--file-cache-max-size-mb=50 --file-cache-cache-file-for-range-read=true --file-cache-enable-parallel-downloads=true --cache-dir=/dev/shm/TestCacheFileForRangeReadTrueWithRamCache --log-file=/gcsfuse-tmp/TestCacheFileForRangeReadTrueWithRamCache.log --log-severity=TRACE"
#          - "--file-cache-max-size-mb=50 --file-cache-cache-file-for-range-read=true --file-cache-enable-parallel-downloads=true --cache-dir=/dev/shm/TestCacheFileForRangeReadTrueWithRamCache --log-file=/gcsfuse-tmp/TestCacheFileForRangeReadTrueWithRamCache.log --log-severity=TRACE --file-cache-enable-o-direct=true"
#          - "--file-cache-max-size-mb=50 --file-cache-cache-file-for-range-read=true --file-cache-enable-parallel-downloads=false --cache-dir=/dev/shm/TestCacheFileForRangeReadTrueWithRamCache --log-file=/gcsfuse-tmp/TestCacheFileForRangeReadTrueWithRamCache.log --log-severity=TRACE"
#          - "--file-cache-max-size-mb=50 --file-cache-cache-file-for-range-read=true --file-cache-enable-parallel-downloads=true --cache-dir=/dev/shm/TestCacheFileForRangeReadTrueWithRamCache --log-file=/gcsfuse-tmp/TestCacheFileForRangeReadTrueWithRamCache.log --log-severity=TRACE --client-protocol=grpc"
#          - "--file-cache-max-size-mb=50 --file-cache-cache-file-for-range-read=true --file-cache-enable-parallel-downloads=true --cache-dir=/dev/shm/TestCacheFileForRangeReadTrueWithRamCache --log-file=/gcsfuse-tmp/TestCacheFileForRangeReadTrueWithRamCache.log --log-severity=TRACE --file-cache-enable-o-direct=true --client-protocol=grpc"
#          - "--file-cache-max-size-mb=50 --file-cache-cache-file-for-range-read=true --file-cache-enable-parallel-downloads=false --cache-dir=/dev/shm/TestCacheFileForRangeReadTrueWithRamCache --log-file=/gcsfuse-tmp/TestCacheFileForRangeReadTrueWithRamCache.log --log-severity=TRACE --client-protocol=grpc"
#        compatible:
#          flat: true
#          hns: true
#          zonal: true
#        run: TestCacheFileForRangeReadTrueWithRamCache
#        run_on_gke: true
      - flags:
          - "--implicit-dirs --file-cache-max-size-mb=50 --file-cache-enable-parallel-downloads=false --cache-dir=/gcsfuse-tmp/TestCacheFileForRangeReadFalseTest --log-file=/gcsfuse-tmp/TestCacheFileForRangeReadFalseTest.log --log-severity=TRACE"
          - "--implicit-dirs --file-cache-max-size-mb=50 --file-cache-enable-parallel-downloads=false --cache-dir=/gcsfuse-tmp/TestCacheFileForRangeReadFalseTest --log-file=/gcsfuse-tmp/TestCacheFileForRangeReadFalseTest.log --log-severity=TRACE --client-protocol=grpc"
        compatible:
          flat: true
          hns: true
          zonal: true
        run: TestCacheFileForRangeReadFalseTest
        run_on_gke: true
#      - flags:
#          - "--file-cache-max-size-mb=50 --file-cache-enable-parallel-downloads=false --cache-dir=/dev/shm/TestCacheFileForRangeReadFalseWithRamCache --log-file=/gcsfuse-tmp/TestCacheFileForRangeReadFalseWithRamCache.log --log-severity=TRACE"
#          - "--file-cache-max-size-mb=50 --file-cache-enable-parallel-downloads=false --cache-dir=/dev/shm/TestCacheFileForRangeReadFalseWithRamCache --log-file=/gcsfuse-tmp/TestCacheFileForRangeReadFalseWithRamCache.log --log-severity=TRACE --client-protocol=grpc"
#        compatible:
#          flat: true
#          hns: true
#          zonal: true
#        run: TestCacheFileForRangeReadFalseWithRamCache
#        run_on_gke: true
      - flags:
          - "--file-cache-max-size-mb=50 --file-cache-enable-parallel-downloads=true --cache-dir=/gcsfuse-tmp/TestCacheFileForRangeReadFalseWithParallelDownloads --log-file=/gcsfuse-tmp/TestCacheFileForRangeReadFalseWithParallelDownloads.log --log-severity=TRACE"
          - "--file-cache-max-size-mb=50 --file-cache-enable-parallel-downloads=true --cache-dir=/gcsfuse-tmp/TestCacheFileForRangeReadFalseWithParallelDownloads --log-file=/gcsfuse-tmp/TestCacheFileForRangeReadFalseWithParallelDownloads.log --log-severity=TRACE --file-cache-enable-o-direct=true"
          - "--file-cache-max-size-mb=50 --file-cache-enable-parallel-downloads=true --cache-dir=/gcsfuse-tmp/TestCacheFileForRangeReadFalseWithParallelDownloads --log-file=/gcsfuse-tmp/TestCacheFileForRangeReadFalseWithParallelDownloads.log --log-severity=TRACE --client-protocol=grpc"
          - "--file-cache-max-size-mb=50 --file-cache-enable-parallel-downloads=true --cache-dir=/gcsfuse-tmp/TestCacheFileForRangeReadFalseWithParallelDownloads --log-file=/gcsfuse-tmp/TestCacheFileForRangeReadFalseWithParallelDownloads.log --log-severity=TRACE --file-cache-enable-o-direct=true --client-protocol=grpc"
        compatible:
          flat: true
          hns: true
          zonal: true
        run: TestCacheFileForRangeReadFalseWithParallelDownloads
        run_on_gke: true
#      - flags:
#          - "--file-cache-max-size-mb=50 --file-cache-enable-parallel-downloads=true --cache-dir=/dev/shm/TestCacheFileForRangeReadFalseWithParallelDownloadsAndRamCache --log-file=/gcsfuse-tmp/TestCacheFileForRangeReadFalseWithParallelDownloadsAndRamCache.log --log-severity=TRACE"
#          - "--file-cache-max-size-mb=50 --file-cache-enable-parallel-downloads=true --cache-dir=/dev/shm/TestCacheFileForRangeReadFalseWithParallelDownloadsAndRamCache --log-file=/gcsfuse-tmp/TestCacheFileForRangeReadFalseWithParallelDownloadsAndRamCache.log --log-severity=TRACE --file-cache-enable-o-direct=true"
#          - "--file-cache-max-size-mb=50 --file-cache-enable-parallel-downloads=true --cache-dir=/dev/shm/TestCacheFileForRangeReadFalseWithParallelDownloadsAndRamCache --log-file=/gcsfuse-tmp/TestCacheFileForRangeReadFalseWithParallelDownloadsAndRamCache.log --log-severity=TRACE --client-protocol=grpc"
#          - "--file-cache-max-size-mb=50 --file-cache-enable-parallel-downloads=true --cache-dir=/dev/shm/TestCacheFileForRangeReadFalseWithParallelDownloadsAndRamCache --log-file=/gcsfuse-tmp/TestCacheFileForRangeReadFalseWithParallelDownloadsAndRamCache.log --log-severity=TRACE --file-cache-enable-o-direct=true --client-protocol=grpc"
#        compatible:
#          flat: true
#          hns: true
#          zonal: true
#        run: TestCacheFileForRangeReadFalseWithParallelDownloadsAndRamCache
#        run_on_gke: true
      - flags:
          - "--file-cache-max-size-mb=48 --file-cache-cache-file-for-range-read=true --file-cache-enable-parallel-downloads=false --cache-dir=/gcsfuse-tmp/TestJobChunkTest --log-file=/gcsfuse-tmp/TestJobChunkTest.log --log-severity=TRACE"
          - "--file-cache-max-size-mb=48 --file-cache-cache-file-for-range-read=true --file-cache-enable-parallel-downloads=false --cache-dir=/gcsfuse-tmp/TestJobChunkTest --log-file=/gcsfuse-tmp/TestJobChunkTest.log --log-severity=TRACE --client-protocol=grpc"
        compatible:
          flat: true
          hns: true
          zonal: true
        run: TestJobChunkTest
        run_on_gke: true
      - flags:
          # with unlimited max parallel downloads.
          - "--file-cache-max-size-mb=48 --file-cache-enable-parallel-downloads=true --file-cache-parallel-downloads-per-file=4 --file-cache-max-parallel-downloads=-1 --file-cache-download-chunk-size-mb=4 --file-cache-enable-crc=true --cache-dir=/gcsfuse-tmp/TestJobChunkTestWithParallelDownloads --log-file=/gcsfuse-tmp/TestJobChunkTestWithParallelDownloads.log --log-severity=TRACE"
          - "--file-cache-max-size-mb=48 --file-cache-enable-parallel-downloads=true --file-cache-parallel-downloads-per-file=4 --file-cache-max-parallel-downloads=-1 --file-cache-download-chunk-size-mb=4 --file-cache-enable-crc=true --cache-dir=/gcsfuse-tmp/TestJobChunkTestWithParallelDownloads --log-file=/gcsfuse-tmp/TestJobChunkTestWithParallelDownloads.log --log-severity=TRACE --client-protocol=grpc"
          # with go-routines not limited by max parallel downloads.
          # maxParallelDownloads > parallelDownloadsPerFile * number of files being accessed concurrently.
          - "--file-cache-max-size-mb=48 --file-cache-enable-parallel-downloads=true --file-cache-parallel-downloads-per-file=4 --file-cache-max-parallel-downloads=9 --file-cache-download-chunk-size-mb=4 --file-cache-enable-crc=true --cache-dir=/gcsfuse-tmp/TestJobChunkTestWithParallelDownloads --log-file=/gcsfuse-tmp/TestJobChunkTestWithParallelDownloads.log --log-severity=TRACE"
          - "--file-cache-max-size-mb=48 --file-cache-enable-parallel-downloads=true --file-cache-parallel-downloads-per-file=4 --file-cache-max-parallel-downloads=9 --file-cache-download-chunk-size-mb=4 --file-cache-enable-crc=true --cache-dir=/gcsfuse-tmp/TestJobChunkTestWithParallelDownloads --log-file=/gcsfuse-tmp/TestJobChunkTestWithParallelDownloads.log --log-severity=TRACE --client-protocol=grpc"
          # with go-routines limited by max parallel downloads.
          - "--file-cache-max-size-mb=48 --file-cache-enable-parallel-downloads=true --file-cache-parallel-downloads-per-file=4 --file-cache-max-parallel-downloads=2 --file-cache-download-chunk-size-mb=4 --file-cache-enable-crc=true --cache-dir=/gcsfuse-tmp/TestJobChunkTestWithParallelDownloads --log-file=/gcsfuse-tmp/TestJobChunkTestWithParallelDownloads.log --log-severity=TRACE"
          - "--file-cache-max-size-mb=48 --file-cache-enable-parallel-downloads=true --file-cache-parallel-downloads-per-file=4 --file-cache-max-parallel-downloads=2 --file-cache-download-chunk-size-mb=4 --file-cache-enable-crc=true --cache-dir=/gcsfuse-tmp/TestJobChunkTestWithParallelDownloads --log-file=/gcsfuse-tmp/TestJobChunkTestWithParallelDownloads.log --log-severity=TRACE --client-protocol=grpc"
        compatible:
          flat: true
          hns: true
          zonal: true
        run: TestJobChunkTestWithParallelDownloads
        run_on_gke: true
      - flags:
          - "--file-cache-exclude-regex=. --file-cache-max-size-mb=50 --file-cache-enable-parallel-downloads=false --cache-dir=/gcsfuse-tmp/TestCacheFileForExcludeRegexTest --log-file=/gcsfuse-tmp/TestCacheFileForExcludeRegexTest.log --log-severity=TRACE"
          - "--file-cache-exclude-regex=. --file-cache-max-size-mb=50 --file-cache-cache-file-for-range-read=true --file-cache-enable-parallel-downloads=false --cache-dir=/gcsfuse-tmp/TestCacheFileForExcludeRegexTest --log-file=/gcsfuse-tmp/TestCacheFileForExcludeRegexTest.log --log-severity=TRACE"
          - "--file-cache-exclude-regex=^${BUCKET_NAME}/ --file-cache-max-size-mb=50 --file-cache-cache-file-for-range-read=true --file-cache-enable-parallel-downloads=false --cache-dir=/gcsfuse-tmp/TestCacheFileForExcludeRegexTest --log-file=/gcsfuse-tmp/TestCacheFileForExcludeRegexTest.log --log-severity=TRACE"
          - "--file-cache-exclude-regex=. --file-cache-max-size-mb=50 --file-cache-enable-parallel-downloads=false --cache-dir=/gcsfuse-tmp/TestCacheFileForExcludeRegexTest --log-file=/gcsfuse-tmp/TestCacheFileForExcludeRegexTest.log --log-severity=TRACE --client-protocol=grpc"
          - "--file-cache-exclude-regex=. --file-cache-max-size-mb=50 --file-cache-cache-file-for-range-read=true --file-cache-enable-parallel-downloads=false --cache-dir=/gcsfuse-tmp/TestCacheFileForExcludeRegexTest --log-file=/gcsfuse-tmp/TestCacheFileForExcludeRegexTest.log --log-severity=TRACE --client-protocol=grpc"
          - "--file-cache-exclude-regex=^${BUCKET_NAME}/ --file-cache-max-size-mb=50 --file-cache-cache-file-for-range-read=true --file-cache-enable-parallel-downloads=false --cache-dir=/gcsfuse-tmp/TestCacheFileForExcludeRegexTest --log-file=/gcsfuse-tmp/TestCacheFileForExcludeRegexTest.log --log-severity=TRACE --client-protocol=grpc"
          # Exclude regex flag takes precedence over include regex flag so files won't be cached.
          - "--file-cache-include-regex=^${BUCKET_NAME}/ --file-cache-exclude-regex=^${BUCKET_NAME}/ --file-cache-max-size-mb=50 --file-cache-cache-file-for-range-read=true --file-cache-enable-parallel-downloads=false --cache-dir=/gcsfuse-tmp/TestCacheFileForExcludeRegexTest --log-file=/gcsfuse-tmp/TestCacheFileForExcludeRegexTest.log --log-severity=TRACE"
          - "--file-cache-include-regex=^${BUCKET_NAME}/ --file-cache-exclude-regex=^${BUCKET_NAME}/ --file-cache-max-size-mb=50 --file-cache-cache-file-for-range-read=true --file-cache-enable-parallel-downloads=false --cache-dir=/gcsfuse-tmp/TestCacheFileForExcludeRegexTest --log-file=/gcsfuse-tmp/TestCacheFileForExcludeRegexTest.log --log-severity=TRACE --client-protocol=grpc"
        compatible:
          flat: true
          hns: true
          zonal: true
        run: TestCacheFileForExcludeRegexTest
        run_on_gke: true
      - flags:
          - "--implicit-dirs --file-cache-max-size-mb=9 --file-cache-enable-parallel-downloads=false --cache-dir=/gcsfuse-tmp/TestRemountTest --log-file=/gcsfuse-tmp/TestRemountTest.log --log-severity=TRACE"
          - "--implicit-dirs --file-cache-max-size-mb=9 --file-cache-enable-parallel-downloads=true --cache-dir=/gcsfuse-tmp/TestRemountTest --log-file=/gcsfuse-tmp/TestRemountTest.log --log-severity=TRACE"
          - "--implicit-dirs --file-cache-max-size-mb=9 --file-cache-enable-parallel-downloads=false --cache-dir=/gcsfuse-tmp/TestRemountTest --log-file=/gcsfuse-tmp/TestRemountTest.log --log-severity=TRACE --client-protocol=grpc"
          - "--implicit-dirs --file-cache-max-size-mb=9 --file-cache-enable-parallel-downloads=true --cache-dir=/gcsfuse-tmp/TestRemountTest --log-file=/gcsfuse-tmp/TestRemountTest.log --log-severity=TRACE --client-protocol=grpc"
        compatible:
          flat: true
          hns: true
          zonal: true
        run: TestRemountTest
        run_on_gke: false
      - flags:
          - "--file-cache-include-regex=^${BUCKET_NAME}/.*ReadCacheTest/foo* --file-cache-exclude-regex= --file-cache-max-size-mb=9 --cache-dir=/gcsfuse-tmp/TestCacheFileForIncludeRegexTest --log-file=/gcsfuse-tmp/TestCacheFileForIncludeRegexTest.log --log-severity=TRACE"
          - "--file-cache-include-regex=^${BUCKET_NAME}/.*ReadCacheTest/foo* --file-cache-exclude-regex= --file-cache-max-size-mb=9 --cache-dir=/gcsfuse-tmp/TestCacheFileForIncludeRegexTest --log-file=/gcsfuse-tmp/TestCacheFileForIncludeRegexTest.log --log-severity=TRACE --client-protocol=grpc"
          - "--file-cache-include-regex=^${BUCKET_NAME}/.*ReadCacheTest/foo* --file-cache-exclude-regex=invalid --file-cache-max-size-mb=9 --cache-dir=/gcsfuse-tmp/TestCacheFileForIncludeRegexTest --log-file=/gcsfuse-tmp/TestCacheFileForIncludeRegexTest.log --log-severity=TRACE"
          - "--file-cache-include-regex=^${BUCKET_NAME}/.*ReadCacheTest/foo* --file-cache-exclude-regex=invalid --file-cache-max-size-mb=9 --cache-dir=/gcsfuse-tmp/TestCacheFileForIncludeRegexTest --log-file=/gcsfuse-tmp/TestCacheFileForIncludeRegexTest.log --log-severity=TRACE --client-protocol=grpc"
        compatible:
          flat: true
          hns: true
          zonal: true
        run: TestCacheFileForIncludeRegexTest
        run_on_gke: true

stale_handle:
  - mounted_directory: "${MOUNTED_DIR}"
    test_bucket: "${BUCKET_NAME}"
    configs:
      - flags:
          - "--metadata-cache-ttl-secs=0 --write-block-size-mb=1 --write-max-blocks-per-file=1"
          - "--metadata-cache-ttl-secs=0 --write-block-size-mb=1 --write-max-blocks-per-file=1 --client-protocol=grpc"
        compatible:
          flat: true
          hns: true
          zonal: true
        run: "TestStaleFileHandleLocalFileTestStreamingWritesEnabled"
        run_on_gke: true
      - flags:
          - "--metadata-cache-ttl-secs=0 --enable-streaming-writes=false"
          - "--metadata-cache-ttl-secs=0 --enable-streaming-writes=false --client-protocol=grpc"
        compatible:
          flat: true
          hns: true
          zonal: true
        run: "TestStaleFileHandleLocalFileTestStreamingWritesDisabled"
        run_on_gke: true
      - flags:
          - "--metadata-cache-ttl-secs=0 --write-block-size-mb=1 --write-max-blocks-per-file=1"
          - "--metadata-cache-ttl-secs=0 --write-block-size-mb=1 --write-max-blocks-per-file=1 --client-protocol=grpc"
        compatible:
          flat: true
          hns: true
          zonal: true
        run: "TestStaleFileHandleEmptyGcsFileTestStreamingWritesEnabled"
        run_on_gke: true
      - flags:
          - "--metadata-cache-ttl-secs=0 --enable-streaming-writes=false"
          - "--metadata-cache-ttl-secs=0 --enable-streaming-writes=false --client-protocol=grpc"
        compatible:
          flat: true
          hns: true
          zonal: true
        run: "TestStaleFileHandleEmptyGcsFileTestStreamingWritesDisabled"
        run_on_gke: true

readdirplus:
  - mounted_directory: "${MOUNTED_DIR}"
    test_bucket: "${BUCKET_NAME}"
    configs:
      - flags:
          - "--implicit-dirs --experimental-enable-readdirplus --experimental-enable-dentry-cache --log-file=/gcsfuse-tmp/TestReaddirplusWithDentryCacheTest.log --log-severity=TRACE"
        compatible:
          flat: true
          hns: true
          zonal: true
        run: TestReaddirplusWithDentryCacheTest
        run_on_gke: true
      - flags:
          - "--implicit-dirs --experimental-enable-readdirplus --log-file=/gcsfuse-tmp/TestReaddirplusWithoutDentryCacheTest.log --log-severity=TRACE"
        compatible:
          flat: true
          hns: true
          zonal: true
        run: TestReaddirplusWithoutDentryCacheTest
        run_on_gke: true

benchmarking:
  - test_bucket: "${BUCKET_NAME}"
    mounted_directory: "${MOUNTED_DIR}"
    configs:
      - flags:
          - "--stat-cache-ttl=0"
          - "--stat-cache-ttl=0 --client-protocol=grpc"
        compatible:
              flat: true
              hns: true
              zonal: true
        run: "Benchmark_Stat"
        run_on_gke: true
      - flags:
          - "--stat-cache-ttl=0 --enable-atomic-rename-object=true"
          - "--stat-cache-ttl=0 --enable-atomic-rename-object=true --client-protocol=grpc"
        compatible:
              flat: true
              hns: true
              zonal: true
        run: "Benchmark_Rename"
        run_on_gke: true
      - flags:
          - "--stat-cache-ttl=0"
          - "--client-protocol=grpc --stat-cache-ttl=0"
        compatible:
              flat: true
              hns: true
              zonal: true
        run: "Benchmark_Delete"
        run_on_gke: true

dentry_cache:
 - mounted_directory: "${MOUNTED_DIR}"
   test_bucket: "${BUCKET_NAME}"
   configs:
     - flags:
       - "--implicit-dirs --experimental-enable-dentry-cache --metadata-cache-ttl-secs=2"
       compatible:
         flat: true
         hns: true
         zonal: true
       run: TestStatWithDentryCacheEnabledTest
       run_on_gke: true
     - flags:
       - "--implicit-dirs --experimental-enable-dentry-cache --metadata-cache-ttl-secs=1000"
       compatible:
         flat: true
         hns: true
         zonal: true
       run: TestDeleteOperationTest
       run_on_gke: true
     - flags:
       - "--implicit-dirs --experimental-enable-dentry-cache --metadata-cache-ttl-secs=1000"
       compatible:
         flat: true
         hns: true
         zonal: true
       run: TestNotifierTest
       run_on_gke: true

read_gcs_algo:
  - mounted_directory: "${MOUNTED_DIR}"
    test_bucket: "${BUCKET_NAME}"
    configs:
      - flags:
        # Do not enable fileCache as we want to test gcs read flow.
          - "--implicit-dirs=true"
        compatible:
          flat: true
          hns: true
          zonal: true
        run_on_gke: true

interrupt:
  - mounted_directory: "${MOUNTED_DIR}"
    test_bucket: "${BUCKET_NAME}"
    configs:
      - flags:
        #TODO(b/417136852): Enable this test for Zonal Bucket also once read start working.
          - "--enable-streaming-writes=true"
        compatible:
          flat: true
          hns: true
          zonal: false
        run_on_gke: true
      - flags:
          - "--implicit-dirs=true --enable-streaming-writes=false"
          - "--ignore-interrupts=true --enable-streaming-writes=false"
          - "--ignore-interrupts=false --enable-streaming-writes=false"
        compatible:
          flat: true
          hns: true
          zonal: true
        run_on_gke: true

flag_optimizations:
  - mounted_directory: "${MOUNTED_DIR}"
    test_bucket: "${BUCKET_NAME}"
    configs:
      - run: TestMountFails
        flags:
          - "--profile=unknown-profile"
        compatible:
          flat: true
          hns: true
          zonal: true
        run_on_gke: false
      - run: TestImplicitDirsNotEnabled
        flags:
          - "--machine-type=low-end-machine"
        compatible:
          flat: true
          hns: false
          zonal: false
        run_on_gke: true
      - run: TestRenameDirLimitNotSet
        flags:
          - "--machine-type=low-end-machine"
          - "--profile=aiml-training"
          - "--profile=aiml-serving"
        compatible:
          flat: true
          hns: false
          zonal: false
        run_on_gke: true
      - run: TestImplicitDirsEnabled
        flags:
          - "--machine-type=a3-highgpu-8g"
          - "--profile=aiml-training"
          - "--profile=aiml-serving"
          - "--profile=aiml-checkpointing"
          - "--machine-type=low-end-machine --profile=aiml-training"
          - "--machine-type=low-end-machine --profile=aiml-serving"
          - "--machine-type=low-end-machine --profile=aiml-checkpointing"
        compatible:
          flat: true
          hns: false
          zonal: false
        run_on_gke: true
      - run: TestRenameDirLimitSet
        flags:
          - "--machine-type=a3-highgpu-8g"
          - "--profile=aiml-checkpointing"
          - "--machine-type=low-end-machine --profile=aiml-checkpointing"
        compatible:
          flat: true
          hns: false
          zonal: false
        run_on_gke: true

// Copyright 2024 Google LLC
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

// Code generated by main.go. DO NOT EDIT.

package {{ .PackageName }}

import (
	"context"
	"fmt"
	"sync/atomic"

	"go.opentelemetry.io/otel"
	"go.opentelemetry.io/otel/attribute"
	"go.opentelemetry.io/otel/metric"
)

var (
	meter = otel.Meter("gcsfuse")
)

type MetricHandle interface {
{{- range .Metrics }}
	{{ .GoName }}(inc int64{{- range .Attributes -}}, {{ .GoName }} {{ .GoType }}{{- end -}})
{{- end }}
}

type otelMetrics struct {
{{- range .Metrics }}
{{- range .Combinations }}
	{{ .AtomicVarName }} *atomic.Int64
{{- end }}
{{- end }}
}

{{- define "SwitchCase" }}
    {{- $node := . -}}
    switch {{ $node.AttributeGoName }} {
    {{- range $val, $childNode := .Children }}
    case {{ if eq $node.AttributeGoType "string" }}"{{ $val }}"{{ else }}{{ $val }}{{ end }}:
        {{- if $childNode.IsLeaf }}
            o.{{ $childNode.LeafVarName }}.Add(inc)
        {{- else }}
            {{- template "SwitchCase" $childNode -}}
        {{- end }}
    {{- end }}
    }
{{- end }}

{{- range .Metrics }}
func (o *otelMetrics) {{ .GoName }}(inc int64{{- range .Attributes -}}, {{ .GoName }} {{ .GoType }}{{- end -}}) {
    {{- if .SwitchTree.IsLeaf }}
        o.{{ .SwitchTree.LeafVarName }}.Add(inc)
    {{- else }}
        {{- template "SwitchCase" .SwitchTree -}}
    {{- end }}
}
{{ end }}

func NewOTelMetrics() (MetricHandle, error) {
{{- range .Metrics }}
{{- range .Combinations }}
	var {{ .AtomicVarName }} atomic.Int64
{{- end }}
{{- end }}

{{- range .Metrics }}
{{- range .Combinations }}
	{{ .AttrSetVarName }} := metric.WithAttributeSet(attribute.NewSet(
		{{- $first := true -}}
		{{- range $attrName, $attrValue := .Attributes -}}
			{{- if not $first -}}, {{ end -}}
			{{- $attr := index $.AttrMap $attrName -}}
			attribute.{{ $attr.GoType | ToOtelType }}("{{ $attrName }}", {{ if eq $attr.GoType "string" }}"{{ $attrValue }}"{{ else }}{{ $attrValue }}{{ end }})
			{{- $first = false -}}
		{{- end -}}
	))
{{- end }}
{{- end }}

{{- range .Metrics }}
	if _, err := meter.Int64ObservableCounter("{{ .Name }}",
		metric.WithDescription("{{ .Description }}"),
		metric.WithUnit("{{ .Unit }}"),
		metric.WithInt64Callback(func(_ context.Context, obsrv metric.Int64Observer) error {
		{{- range .Combinations }}
			obsrv.Observe({{ .AtomicVarName }}.Load(), {{ .AttrSetVarName }})
		{{- end }}
			return nil
		})); err != nil {
		return nil, fmt.Errorf("failed to create observable counter for metric {{ .Name }}: %w", err)
	}
{{ end }}

	return &otelMetrics{
{{- range .Metrics }}
{{- range .Combinations }}
		{{ .AtomicVarName }}: &{{ .AtomicVarName }},
{{- end }}
{{- end }}
	}, nil
}

